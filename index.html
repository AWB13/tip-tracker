<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tip Distribution Calculator</title>
    
    <!-- Desktop/PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tip Calc">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234f46e5%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2260%22 font-family=%22sans-serif%22 font-weight=%22bold%22>$</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background-color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            padding-top: env(safe-area-inset-top);
            /* Standard desktop window behavior */
            min-width: 1200px;
        }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .editable-total:focus { background-color: #fff; outline: 2px solid #6366f1; }
        
        /* Table layout optimizations - Aggressive condensing */
        .staff-table th, .staff-table td { padding: 0.35rem 0.2rem; font-size: 0.7rem; }
        .staff-name-input { min-width: 60px; }
        
        /* Auphen Visual Identification (Indigo) */
        .auphen-bg { background-color: #eef2ff; } 
        .auphen-header { background-color: #4f46e5 !important; color: white !important; }
        
        /* Square Visual Identification (Teal) */
        .square-bg { background-color: #f0fdfa; }
        .square-header { background-color: #0d9488 !important; color: white !important; }

        /* Totals Visual Identification (Slate) */
        .totals-bg { background-color: #f1f5f9; }
        .totals-header { background-color: #334155 !important; color: white !important; }
        
        /* Custom scrollbar for desktop */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .no-print { display: none !important; }
            body { min-width: auto; background-color: white; }
            .card { box-shadow: none; border: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1400px] mx-auto pb-48">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Distribution Calculator</h1>
                <p class="text-slate-500 text-sm">Real-time Tip Allocation Tracking</p>
            </div>
        </header>

        <!-- Configuration & Financials -->
        <div class="space-y-6 mb-6 no-print">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Shift Config -->
                <div class="card p-4 border border-slate-100 shadow-sm">
                    <label class="block text-sm font-semibold text-slate-700 mb-3 tracking-tight">Shift Config</label>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400 uppercase font-bold w-12">Date</span>
                            <input type="date" id="shift-date" class="flex-1 border border-slate-300 rounded-lg p-1.5 bg-white text-sm">
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400 uppercase font-bold w-12">BTs</span>
                            <select id="count-bartender" class="flex-1 border border-slate-300 rounded-lg p-1.5 bg-white text-sm" onchange="window.renderTables()">
                                <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option>
                                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-slate-400 uppercase font-bold w-12">BAs</span>
                            <select id="count-ba" class="flex-1 border border-slate-300 rounded-lg p-1.5 bg-white text-sm" onchange="window.renderTables()">
                                <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Financial Inputs -->
                <div class="card p-4 border border-slate-100 shadow-sm col-span-1 md:col-span-2">
                    <label class="block text-sm font-semibold text-slate-700 mb-3 tracking-tight">Shift Financials</label>
                    <div class="flex flex-wrap items-start gap-3">
                        <!-- Auphen -->
                        <div class="flex-none border-2 border-indigo-200 rounded-xl p-2 bg-indigo-50/30 w-fit">
                            <span class="block text-[10px] text-indigo-600 font-black uppercase tracking-[0.2em] text-center mb-1 border-b border-indigo-100">Auphen</span>
                            <div class="flex gap-2">
                                <div class="w-24">
                                    <span class="text-[9px] text-slate-500 uppercase font-bold">Remit</span>
                                    <input type="number" id="micros-remit" placeholder="0.00" class="w-full border border-indigo-200 rounded-lg p-1.5 font-mono text-sm outline-none focus:ring-2 focus:ring-indigo-500" oninput="window.calculate()">
                                </div>
                                <div class="w-24">
                                     <span class="text-[9px] text-slate-500 uppercase font-bold">Net Sales</span>
                                     <input type="number" id="net-sales" placeholder="0.00" class="w-full border border-indigo-200 rounded-lg p-1.5 font-mono text-sm outline-none focus:ring-2 focus:ring-indigo-500" oninput="window.calculate()">
                                </div>
                            </div>
                        </div>

                        <!-- Square -->
                        <div class="flex-none border-2 border-teal-200 rounded-xl p-2 bg-teal-50/30 w-fit">
                            <span class="block text-[10px] text-teal-600 font-black uppercase tracking-[0.2em] text-center mb-1 border-b border-teal-100">Square</span>
                            <div class="flex gap-2">
                                <div class="w-24">
                                    <span class="text-[9px] text-slate-500 uppercase font-bold">Remit</span>
                                    <input type="number" id="square-remit" placeholder="0.00" class="w-full border border-teal-200 rounded-lg p-1.5 bg-white font-mono text-sm outline-none focus:ring-2 focus:ring-teal-500" oninput="window.calculate()">
                                </div>
                                <div class="w-24">
                                     <span class="text-[9px] text-slate-500 uppercase font-bold">Net Sales</span>
                                     <input type="number" id="square-net-sales" placeholder="0.00" class="w-full border border-teal-200 rounded-lg p-1.5 font-mono text-sm outline-none focus:ring-2 focus:ring-teal-500" oninput="window.calculate()">
                                </div>
                            </div>
                        </div>

                        <!-- Cash -->
                        <div class="w-24">
                            <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Cash</span>
                            <input type="number" id="cash-received" placeholder="0.00" class="w-full border border-slate-300 rounded-lg p-2 bg-green-50 font-mono text-sm text-green-700 mt-[14px] outline-none focus:ring-2 focus:ring-green-500" oninput="window.calculate()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
            <div class="card p-4 border-l-4 border-slate-400 bg-slate-50 shadow-sm">
                <h3 class="text-slate-500 text-[10px] font-bold uppercase">Total Net Sales</h3>
                <p id="display-net-total" class="text-lg font-mono font-bold text-slate-800">$0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-indigo-600 bg-indigo-50 shadow-sm">
                <h3 class="text-indigo-600 text-[10px] font-bold uppercase">Auphen Svc</h3>
                <p id="display-service-charge" class="text-lg font-mono font-bold text-indigo-700">$0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-teal-600 bg-teal-50 shadow-sm">
                <h3 class="text-teal-600 text-[10px] font-bold uppercase">Square Svc</h3>
                <p id="display-square-service" class="text-lg font-mono font-bold text-teal-700">$0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-green-600 shadow-sm">
                <h3 class="text-green-600 text-[10px] font-bold uppercase">Total Cash</h3>
                <p id="display-total-cash" class="text-lg font-mono font-bold text-green-700">$0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-emerald-600 shadow-sm">
                <h3 class="text-emerald-600 text-[10px] font-bold uppercase">Total Tip Hrs</h3>
                <p id="display-total-tip-hours" class="text-lg font-mono font-bold text-emerald-700">0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-slate-800 bg-slate-800 shadow-sm">
                <h3 class="text-slate-400 text-[10px] font-bold uppercase">Grand Pool</h3>
                <p id="display-grand-total" class="text-lg font-mono font-bold text-white">$0.00</p>
            </div>
        </div>

        <!-- Tables -->
        <div class="space-y-8 mb-12">
            <section>
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs mr-2" id="label-bt-count">0</span>
                    Bartender Allocation
                </h2>
                <div class="card overflow-x-auto shadow-sm border border-slate-100">
                    <table class="w-full text-left min-w-[1100px] staff-table">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th rowspan="2" class="pl-2 text-[9px] uppercase align-middle">Name</th>
                                <th rowspan="2" class="w-12 text-center text-[9px] uppercase text-slate-800 align-middle border-r">Hrs</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] auphen-header">Auphen</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] square-header">Square</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] totals-header">Totals</th>
                                <th rowspan="2" class="text-right text-[9px] uppercase text-green-700 align-middle border-l w-20">Cash</th>
                                <th rowspan="2" class="text-right pr-2 text-[9px] uppercase text-slate-800 bg-slate-100 font-bold border-l align-middle w-24">Total</th>
                            </tr>
                            <tr>
                                <th class="text-right text-[9px] uppercase auphen-bg border-l border-indigo-200 w-20">XTM</th>
                                <th class="text-right text-[9px] uppercase auphen-bg border-r border-indigo-200 w-20">CTRL</th>
                                <th class="text-right text-[9px] uppercase square-bg border-l border-teal-200 w-20">XTM</th>
                                <th class="text-right text-[9px] uppercase square-bg border-r border-teal-200 w-20">CTRL</th>
                                <th class="text-right text-[9px] uppercase totals-bg border-l border-slate-300 font-bold w-20">Total XTM</th>
                                <th class="text-right text-[9px] uppercase totals-bg border-r border-slate-300 font-bold w-20">Total CTRL</th>
                            </tr>
                        </thead>
                        <tbody id="table-bartender" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <section>
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs mr-2" id="label-ba-count">0</span>
                    BA Allocation
                </h2>
                <div class="card overflow-x-auto shadow-sm border border-slate-100">
                    <table class="w-full text-left min-w-[1100px] staff-table">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th rowspan="2" class="pl-2 text-[9px] uppercase align-middle">Name</th>
                                <th rowspan="2" class="w-12 text-center text-[9px] uppercase text-slate-800 align-middle border-r">Hrs</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] auphen-header">Auphen</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] square-header">Square</th>
                                <th colspan="2" class="text-center text-[10px] uppercase font-black tracking-[0.1em] totals-header">Totals</th>
                                <th rowspan="2" class="text-right text-[9px] uppercase text-green-700 align-middle border-l w-20">Cash</th>
                                <th rowspan="2" class="text-right pr-2 text-[9px] uppercase text-slate-800 bg-slate-100 font-bold border-l align-middle w-24">Total</th>
                            </tr>
                            <tr>
                                <th class="text-right text-[9px] uppercase auphen-bg border-l border-indigo-200 w-20">XTM</th>
                                <th class="text-right text-[9px] uppercase auphen-bg border-r border-indigo-200 w-20">CTRL</th>
                                <th class="text-right text-[9px] uppercase square-bg border-l border-teal-200 w-20">XTM</th>
                                <th class="text-right text-[9px] uppercase square-bg border-r border-teal-200 w-20">CTRL</th>
                                <th class="text-right text-[9px] uppercase totals-bg border-l border-slate-300 font-bold w-20">Total XTM</th>
                                <th class="text-right text-[9px] uppercase totals-bg border-r border-slate-300 font-bold w-20">Total CTRL</th>
                            </tr>
                        </thead>
                        <tbody id="table-ba" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <script>
        window.formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);

        window.calculate = () => {
            const setUI = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.innerText = val;
            };

            const aNet = parseFloat(document.getElementById('net-sales').value) || 0;
            const aRemit = parseFloat(document.getElementById('micros-remit').value) || 0;
            const aSvcTotal = aNet * 0.10;

            const sNet = parseFloat(document.getElementById('square-net-sales').value) || 0;
            const sRemit = parseFloat(document.getElementById('square-remit').value) || 0;
            const sSvcTotal = sNet * 0.10;

            const cashTotal = parseFloat(document.getElementById('cash-received').value) || 0;

            setUI('display-service-charge', window.formatCurrency(aSvcTotal));
            setUI('display-square-service', window.formatCurrency(sSvcTotal));
            setUI('display-total-cash', window.formatCurrency(cashTotal));
            setUI('display-net-total', window.formatCurrency(aNet + sNet));
            
            const grandPool = aSvcTotal + aRemit + sSvcTotal + sRemit + cashTotal;
            setUI('display-grand-total', window.formatCurrency(grandPool));

            const rows = document.querySelectorAll('.staff-row');
            let totalTipHours = 0;
            let staffList = [];

            rows.forEach((row, index) => {
                const tipHoursInput = row.querySelector('.tip-hour-input');
                const tipHours = parseFloat(tipHoursInput.value) || 0;
                totalTipHours += tipHours;

                staffList.push({
                    id: index, tipHours: tipHours,
                    isManual: row.dataset.manualOverride === "true",
                    manualTotal: parseFloat(row.querySelector('.total-due-input')?.value || 0),
                    type: row.dataset.type,
                    name: row.querySelector('.staff-name-input')?.value || `${row.dataset.type} #${index + 1}`
                });
            });

            setUI('display-total-tip-hours', totalTipHours.toFixed(2));
            window.distribute(aSvcTotal, aRemit, sSvcTotal, sRemit, cashTotal, totalTipHours, staffList);
        };

        window.distribute = (aSvc, aRemit, sSvc, sRemit, cash, totalTipH, staffList) => {
            const grandPoolTotal = aSvc + aRemit + sSvc + sRemit + cash;
            
            const aSvcRatio = grandPoolTotal > 0 ? aSvc / grandPoolTotal : 0;
            const aRemitRatio = grandPoolTotal > 0 ? aRemit / grandPoolTotal : 0;
            const sSvcRatio = grandPoolTotal > 0 ? sSvc / grandPoolTotal : 0;
            const sRemitRatio = grandPoolTotal > 0 ? sRemit / grandPoolTotal : 0;
            const cashRatio = grandPoolTotal > 0 ? cash / grandPoolTotal : 0;

            let allocatedASvc = 0, allocatedARemit = 0, allocatedSSvc = 0, allocatedSRemit = 0, allocatedCash = 0;
            let remainingTipH = 0;

            staffList.forEach(s => {
                if (s.isManual) {
                    s.aSvcShare = s.manualTotal * aSvcRatio;
                    s.aRemitShare = s.manualTotal * aRemitRatio;
                    s.sSvcShare = s.manualTotal * sSvcRatio;
                    s.sRemitShare = s.manualTotal * sRemitRatio;
                    s.cashShare = s.manualTotal * cashRatio;
                    allocatedASvc += s.aSvcShare; allocatedARemit += s.aRemitShare;
                    allocatedSSvc += s.sSvcShare; allocatedSRemit += s.sRemitShare;
                    allocatedCash += s.cashShare;
                } else remainingTipH += s.tipHours;
            });

            const leftASvc = aSvc - allocatedASvc;
            const leftARemit = aRemit - allocatedARemit;
            const leftSSvc = sSvc - allocatedSSvc;
            const leftSRemit = sRemit - allocatedSRemit;
            const leftCash = cash - allocatedCash;

            const aSvcRate = remainingTipH > 0 ? leftASvc / remainingTipH : 0;
            const aRemitRate = remainingTipH > 0 ? leftARemit / remainingTipH : 0;
            const sSvcRate = remainingTipH > 0 ? leftSSvc / remainingTipH : 0;
            const sRemitRate = remainingTipH > 0 ? leftSRemit / remainingTipH : 0;
            const cashRate = remainingTipH > 0 ? leftCash / remainingTipH : 0;

            staffList.forEach(s => {
                if (!s.isManual) {
                    s.aSvcShare = s.tipHours * aSvcRate;
                    s.aRemitShare = s.tipHours * aRemitRate;
                    s.sSvcShare = s.tipHours * sSvcRate;
                    s.sRemitShare = s.tipHours * sRemitRate;
                    s.cashShare = s.tipHours * cashRate;
                }
            });

            const rows = document.querySelectorAll('.staff-row');
            staffList.forEach((s, i) => {
                const row = rows[i];
                row.querySelector('.aSvc-share-cell').innerText = window.formatCurrency(s.aSvcShare);
                row.querySelector('.aRemit-share-cell').innerText = window.formatCurrency(s.aRemitShare);
                row.querySelector('.sSvc-share-cell').innerText = window.formatCurrency(s.sSvcShare);
                row.querySelector('.sRemit-share-cell').innerText = window.formatCurrency(s.sRemitShare);
                row.querySelector('.total-controlled-cell').innerText = window.formatCurrency(s.aSvcShare + s.sSvcShare);
                row.querySelector('.total-xtm-cell').innerText = window.formatCurrency(s.aRemitShare + s.sRemitShare);
                row.querySelector('.cash-share-cell').innerText = window.formatCurrency(s.cashShare);
                const totalInput = row.querySelector('.total-due-input');
                const finalSum = s.aSvcShare + s.aRemitShare + s.sSvcShare + s.sRemitShare + s.cashShare;
                if (totalInput && !s.isManual) totalInput.value = finalSum.toFixed(2);
                else if (!totalInput) row.querySelector('.total-due-cell').innerText = window.formatCurrency(finalSum);
            });
        };

        window.renderTables = () => {
            const btCount = parseInt(document.getElementById('count-bartender').value);
            const baCount = parseInt(document.getElementById('count-ba').value);
            const btC = document.getElementById('table-bartender'), baC = document.getElementById('table-ba');
            const btL = document.getElementById('label-bt-count'), baL = document.getElementById('label-ba-count');
            if (btL) btL.innerText = btCount;
            if (baL) baL.innerText = baCount;
            btC.innerHTML = ''; baC.innerHTML = '';
            
            const createRow = (id, prefix, defTipH, isBA) => `
                <tr class="staff-row" data-type="${prefix}" data-manual-override="false">
                    <td class="pl-2"><input type="text" placeholder="Name..." class="staff-name-input bg-transparent border-b border-slate-200 focus:outline-none w-full text-xs py-1" oninput="window.calculate()"></td>
                    <td class="text-center border-r"><input type="number" step="0.1" value="${defTipH}" class="tip-hour-input w-9 border rounded p-0.5 text-center font-mono text-[10px] font-bold" oninput="window.calculate()"></td>
                    
                    <!-- Auphen Shares (XTM then CTRL) -->
                    <td class="text-right font-mono font-bold text-indigo-600 aRemit-share-cell text-[9px] auphen-bg border-l border-indigo-200">$0.00</td>
                    <td class="text-right font-mono font-bold text-indigo-700 aSvc-share-cell text-[9px] auphen-bg border-r border-indigo-200">$0.00</td>
                    
                    <!-- Square Shares (XTM then CTRL) -->
                    <td class="text-right font-mono font-bold text-teal-600 sRemit-share-cell text-[9px] square-bg border-l border-teal-200">$0.00</td>
                    <td class="text-right font-mono font-bold text-teal-700 sSvc-share-cell text-[9px] square-bg border-r border-teal-200">$0.00</td>
                    
                    <!-- Totals (Total XTM then Total CTRL) -->
                    <td class="text-right font-mono font-bold text-slate-700 total-xtm-cell text-[9px] totals-bg border-l border-slate-300">$0.00</td>
                    <td class="text-right font-mono font-bold text-slate-700 total-controlled-cell text-[9px] totals-bg border-r border-slate-300">$0.00</td>

                    <td class="text-right font-mono font-bold text-green-700 cash-share-cell text-[9px] border-l">$0.00</td>
                    <td class="text-right pr-2 bg-slate-50 border-l font-bold">
                        ${isBA ? `<input type="number" step="0.01" placeholder="0.00" class="total-due-input w-14 border rounded p-0.5 text-right font-mono font-bold text-slate-900 editable-total text-[9px]" oninput="window.handleManualTotal(this)">` : `<span class="total-due-cell font-mono font-bold text-slate-900 text-[9px]">$0.00</span>`}
                    </td>
                </tr>`;
            for (let i = 1; i <= btCount; i++) btC.innerHTML += createRow(i, 'BT', 5, false);
            for (let i = 1; i <= baCount; i++) baC.innerHTML += createRow(i, 'BA', 2.5, true);
            window.calculate();
        };

        window.handleManualTotal = (i) => { i.closest('.staff-row').dataset.manualOverride = (i.value===""||parseFloat(i.value)===0)?"false":"true"; window.calculate(); };

        window.addEventListener('load', () => {
            const dateInput = document.getElementById('shift-date');
            if (dateInput) dateInput.valueAsDate = new Date();
            window.renderTables();
        });
    </script>
</body>
</html>
