<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tip Distribution Calculator</title>
    
    <!-- PWA / iOS Native App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tip Calc">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%234f46e5%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2260%22 font-family=%22sans-serif%22 font-weight=%22bold%22>$</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; padding-top: env(safe-area-inset-top); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .editable-total:focus { background-color: #fff; outline: 2px solid #6366f1; }
        .actual-hrs-cell { background-color: #f1f5f9; }
        
        /* Table layout optimizations */
        .staff-table th, .staff-table td { padding: 0.5rem 0.25rem; font-size: 0.75rem; }
        .staff-name-input { min-width: 70px; }
        html, body { overscroll-behavior-y: contain; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto pb-48">
        <header class="mb-8 text-center md:text-left">
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Distribution Calculator</h1>
            <p class="text-slate-500 text-sm">Real-time Clocked Hours & Tip Allocation</p>
        </header>

        <!-- Configuration -->
        <div class="card p-6 mb-6 grid grid-cols-1 md:grid-cols-2 gap-8 shadow-sm border border-slate-100">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-4 tracking-tight">Shift Configuration</label>
                <div class="grid grid-cols-3 gap-3">
                    <div class="flex-1">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Date</span>
                        <input type="date" id="shift-date" class="w-full border border-slate-300 rounded-lg p-2 bg-white shadow-sm text-sm">
                    </div>
                    <div class="flex-1">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Bartenders</span>
                        <select id="count-bartender" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white shadow-sm text-sm" onchange="window.renderTables()">
                            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option>
                            <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                            <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">BAs</span>
                        <select id="count-ba" class="w-full border border-slate-300 rounded-lg p-2.5 bg-white shadow-sm text-sm" onchange="window.renderTables()">
                            <option value="1">1</option><option value="2" selected>2</option><option value="3">3</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-4 tracking-tight">Financials</label>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                         <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Net Sales</span>
                         <input type="number" id="net-sales" placeholder="0.00" class="w-full border border-slate-300 rounded-lg p-2.5 font-mono text-sm" oninput="window.calculate()">
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Remit</span>
                        <input type="number" id="micros-remit" placeholder="0.00" class="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 font-mono text-sm" oninput="window.calculate()">
                    </div>
                    <div>
                        <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Cash</span>
                        <input type="number" id="cash-received" placeholder="0.00" class="w-full border border-slate-300 rounded-lg p-2.5 bg-green-50 font-mono text-sm text-green-700" oninput="window.calculate()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card p-4 border-l-4 border-slate-400 bg-slate-50 shadow-sm">
                <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Svc Chg (10%)</h3>
                <p id="display-service-charge" class="text-lg font-mono font-bold text-indigo-700">$0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-emerald-600 shadow-sm">
                <h3 class="text-emerald-600 text-[10px] font-bold uppercase tracking-wider">Total Tip Hrs</h3>
                <p id="display-total-tip-hours" class="text-lg font-mono font-bold text-emerald-700">0.00</p>
            </div>
            <div class="card p-4 border-l-4 border-slate-200 col-span-2 shadow-sm">
                <h3 class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Net Sales</h3>
                <p id="display-net-total" class="text-lg font-mono font-bold text-slate-800">$0.00</p>
            </div>
        </div>

        <!-- Tables -->
        <div class="space-y-8 mb-12">
            <section>
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs mr-2" id="label-bt-count">0</span>
                    Bartender Allocation
                </h2>
                <div class="card overflow-x-auto shadow-sm border border-slate-100">
                    <table class="w-full text-left min-w-[850px] staff-table">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="pl-4 text-[9px] uppercase">Name</th>
                                <th class="w-20 text-center text-[9px] uppercase text-slate-500">Start</th>
                                <th class="w-20 text-center text-[9px] uppercase text-slate-500">Finish</th>
                                <th class="w-16 text-center text-[9px] uppercase text-slate-500 bg-slate-100">Clocked</th>
                                <th class="w-14 text-center text-[9px] uppercase text-slate-800">Tip Hrs</th>
                                <th class="text-right text-[9px] uppercase">Svc Chg</th>
                                <th class="text-right text-[9px] uppercase">Remit</th>
                                <th class="text-right text-[9px] uppercase text-green-700">Cash</th>
                                <th class="text-right pr-4 text-[9px] uppercase text-slate-800 bg-slate-100 font-bold border-l">Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-bartender" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <section>
                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs mr-2" id="label-ba-count">0</span>
                    BA Allocation
                </h2>
                <div class="card overflow-x-auto shadow-sm border border-slate-100">
                    <table class="w-full text-left min-w-[850px] staff-table">
                        <thead class="bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th class="pl-4 text-[9px] uppercase">Name</th>
                                <th class="w-20 text-center text-[9px] uppercase text-slate-500">Start</th>
                                <th class="w-20 text-center text-[9px] uppercase text-slate-500">Finish</th>
                                <th class="w-16 text-center text-[9px] uppercase text-slate-500 bg-slate-100">Clocked</th>
                                <th class="w-14 text-center text-[9px] uppercase text-slate-800">Tip Hrs</th>
                                <th class="text-right text-[9px] uppercase">Svc Chg</th>
                                <th class="text-right text-[9px] uppercase">Remit</th>
                                <th class="text-right text-[9px] uppercase text-green-700">Cash</th>
                                <th class="text-right pr-4 text-[9px] uppercase text-slate-800 bg-slate-100 font-bold border-l">Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-ba" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Actions Footer -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-lg z-50">
        <div class="max-w-7xl mx-auto flex justify-center">
            <button onclick="window.calculate()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-md active:scale-[0.98]">
                Recalculate Totals
            </button>
        </div>
    </div>

    <script>
        window.formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);

        window.calculate = () => {
            const netSales = parseFloat(document.getElementById('net-sales').value) || 0;
            const microsRemit = parseFloat(document.getElementById('micros-remit').value) || 0;
            const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
            const serviceChargeTotal = netSales * 0.10;

            const elNet = document.getElementById('display-net-total');
            const elSvc = document.getElementById('display-service-charge');
            const elHrs = document.getElementById('display-total-tip-hours');

            if (elNet) elNet.innerText = window.formatCurrency(netSales);
            if (elSvc) elSvc.innerText = window.formatCurrency(serviceChargeTotal);

            const rows = document.querySelectorAll('.staff-row');
            let totalTipHours = 0;
            let staffList = [];

            rows.forEach((row, index) => {
                const startTime = row.querySelector('.time-start').value;
                const endTime = row.querySelector('.time-end').value;
                const actualHoursDisplay = row.querySelector('.actual-hours-display');
                const tipHoursInput = row.querySelector('.tip-hour-input');
                
                let actualHours = 0;
                if (startTime && endTime) {
                    const start = new Date(`2000-01-01T${startTime}`);
                    let end = new Date(`2000-01-01T${endTime}`);
                    if (end < start) end.setDate(end.getDate() + 1);
                    actualHours = (end - start) / 3600000;
                    if (actualHoursDisplay) actualHoursDisplay.innerText = actualHours.toFixed(2);
                }

                const tipHours = parseFloat(tipHoursInput.value) || 0;
                totalTipHours += tipHours;

                staffList.push({
                    id: index, actualHours: actualHours, tipHours: tipHours,
                    isManual: row.dataset.manualOverride === "true",
                    manualTotal: parseFloat(row.querySelector('.total-due-input')?.value || 0),
                    type: row.dataset.type,
                    name: row.querySelector('.staff-name-input')?.value || `${row.dataset.type} #${index + 1}`
                });
            });

            if (elHrs) elHrs.innerText = totalTipHours.toFixed(2);
            window.distribute(serviceChargeTotal, microsRemit, cashReceived, totalTipHours, staffList);
        };

        window.distribute = (totalS, totalR, totalC, totalTipH, staffList) => {
            const grandTotal = totalS + totalR + totalC;
            const sRatio = grandTotal > 0 ? totalS / grandTotal : 0;
            const rRatio = grandTotal > 0 ? totalR / grandTotal : 0;
            const cRatio = grandTotal > 0 ? totalC / grandTotal : 0;

            let allocatedS = 0, allocatedR = 0, allocatedC = 0, remainingTipH = 0;

            staffList.forEach(s => {
                if (s.isManual) {
                    s.sShare = s.manualTotal * sRatio;
                    s.rShare = s.manualTotal * rRatio;
                    s.cShare = s.manualTotal * cRatio;
                    allocatedS += s.sShare; allocatedR += s.rShare; allocatedC += s.cShare;
                } else remainingTipH += s.tipHours;
            });

            const leftS = totalS - allocatedS; const leftR = totalR - allocatedR; const leftC = totalC - allocatedC;
            const sRate = remainingTipH > 0 ? leftS / remainingTipH : 0;
            const rRate = remainingTipH > 0 ? leftR / remainingTipH : 0;
            const cRate = remainingTipH > 0 ? leftC / remainingTipH : 0;

            staffList.forEach(s => {
                if (!s.isManual) {
                    s.sShare = s.tipHours * sRate; s.rShare = s.tipHours * rRate; s.cShare = s.tipHours * cRate;
                }
            });

            const rows = document.querySelectorAll('.staff-row');
            staffList.forEach((s, i) => {
                const row = rows[i];
                row.querySelector('.service-share-cell').innerText = window.formatCurrency(s.sShare);
                row.querySelector('.remit-share-cell').innerText = window.formatCurrency(s.rShare);
                row.querySelector('.cash-share-cell').innerText = window.formatCurrency(s.cShare);
                const totalInput = row.querySelector('.total-due-input');
                const finalSum = s.sShare + s.rShare + s.cShare;
                if (totalInput && !s.isManual) totalInput.value = finalSum.toFixed(2);
                else if (!totalInput) row.querySelector('.total-due-cell').innerText = window.formatCurrency(finalSum);
            });
        };

        window.renderTables = () => {
            const btCount = parseInt(document.getElementById('count-bartender').value);
            const baCount = parseInt(document.getElementById('count-ba').value);
            const btC = document.getElementById('table-bartender'), baC = document.getElementById('table-ba');
            const btL = document.getElementById('label-bt-count'), baL = document.getElementById('label-ba-count');
            
            if (btL) btL.innerText = btCount;
            if (baL) baL.innerText = baCount;
            btC.innerHTML = ''; baC.innerHTML = '';
            
            const createRow = (id, prefix, defTipH, isBA) => `
                <tr class="staff-row" data-type="${prefix}" data-manual-override="false">
                    <td class="pl-4"><input type="text" placeholder="Name..." class="staff-name-input bg-transparent border-b border-slate-200 focus:outline-none w-full text-xs py-1" oninput="window.calculate()"></td>
                    <td class="text-center"><input type="time" class="time-start text-[10px] border rounded p-0.5" oninput="window.calculate()"></td>
                    <td class="text-center"><input type="time" class="time-end text-[10px] border rounded p-0.5" oninput="window.calculate()"></td>
                    <td class="text-center actual-hrs-cell font-mono text-[10px] font-bold text-slate-500 actual-hours-display">0.00</td>
                    <td class="text-center"><input type="number" step="0.1" value="${defTipH}" class="tip-hour-input w-12 border rounded p-1 text-center font-mono text-[10px] font-bold" oninput="window.calculate()"></td>
                    <td class="text-right font-mono font-bold text-indigo-700 service-share-cell text-[9px]">$0.00</td>
                    <td class="text-right font-mono font-bold text-slate-500 remit-share-cell text-[9px]">$0.00</td>
                    <td class="text-right font-mono font-bold text-green-700 cash-share-cell text-[9px]">$0.00</td>
                    <td class="text-right pr-4 bg-slate-50 border-l">
                        ${isBA ? `<input type="number" step="0.01" placeholder="0.00" class="total-due-input w-16 border rounded p-1 text-right font-mono font-bold text-slate-900 editable-total text-[9px]" oninput="window.handleManualTotal(this)">` : `<span class="total-due-cell font-mono font-bold text-slate-900 text-[9px]">$0.00</span>`}
                    </td>
                </tr>`;
            
            for (let i = 1; i <= btCount; i++) btC.innerHTML += createRow(i, 'BT', 5, false);
            for (let i = 1; i <= baCount; i++) baC.innerHTML += createRow(i, 'BA', 2.5, true);
            window.calculate();
        };

        window.handleManualTotal = (i) => { i.closest('.staff-row').dataset.manualOverride = (i.value===""||parseFloat(i.value)===0)?"false":"true"; window.calculate(); };

        window.addEventListener('load', () => {
            const dateInput = document.getElementById('shift-date');
            if (dateInput) dateInput.valueAsDate = new Date();
            window.renderTables();
        });
    </script>
</body>
</html>
